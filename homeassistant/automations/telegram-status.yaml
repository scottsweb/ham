alias: 'Telegram Status'
initial_state: true
trigger:
  platform: event
  event_type: telegram_callback
  event_data:
    data: '/status'
action:
  - service: telegram_bot.edit_replymarkup
    data_template:
      message_id: '{{ trigger.event.data.message.message_id }}'
      chat_id: '{{ trigger.event.data.chat_id }}'
      inline_keyboard: []
  - service: telegram_bot.send_message
    data_template:
      target: '{{ trigger.event.data.chat_id }}'
      disable_notification: true
      message: >
        Inside it is {{ states.climate.hallway.attributes['current_temperature'] }} degrees with around {{ states('sensor.hallway_thermostat_humidity') }} percent humidity. The thermostat is set to "{{ states('sensor.hallway_thermostat_operation_mode') }}" and targeting {{ states('sensor.hallway_thermostat_target') }} degress.


        Outside, it is {{ states('sensor.dark_sky_summary') }} and {{ states('sensor.dark_sky_temperature') }} degrees. The air pollution level is {{ states('sensor.u_s_air_pollution_level') }} and the UV Index {{ states('sensor.dark_sky_uv_index') }}.


        {% if states.group.lights.state != 'off' -%}
          There are
          {%- for entity_id in states.group.lights.attributes.entity_id if states(entity_id) == 'on' -%}
            {%- if states(entity_id) == 'on' %}
              {%- if loop.last %} {{ loop.index }}{%- endif -%}
            {%- endif -%}
          {%- endfor %} lights on right now:
          {%- for entity_id in states.group.lights.attributes.entity_id if states(entity_id) == 'on' -%}
            {% set parts = entity_id.split('.') -%}
            {%- if loop.first %} {% elif loop.last %} and the {% else %}, the {% endif -%}{{ states[parts[0]][parts[1]].name }}
          {%- endfor %}.
        {%- else -%}
          The are no lights on at the moment.
        {%- endif %}


        {% if is_state('switch.tv', 'on') -%}
          The TV is on and {{ states('media_player.luther_universal_tv') }}:
          {%- if states.media_player.luther_universal_tv.attributes['media_title'] %} {{ states.media_player.luther_universal_tv.attributes['media_title'] }}{%- elif states.media_player.luther_universal_tv.attributes['source'] %} {{ states.media_player.luther_universal_tv.attributes['source'] }}{%- endif -%}
        {%- else -%}
          The TV is currently switched off.
        {%- endif %}


        {% for state in states.device_tracker -%}{% if state.state == 'home' %}{{ state.name }} is home. {% endif %}{%- endfor %}

        {% for state in states.device_tracker -%}{% if state.state == 'not_home' %}{{ state.name }} is away from home. {% endif %}{%- endfor %}


        {% if is_state('binary_sensor.iss', 'on') -%}
          Fun fact, the ISS is overhead the house right now. There are {{ states.binary_sensor.iss.attributes['number_of_people_in_space'] }} people in space.
        {% endif -%}


        If you are home, you will find Home Assistant at http://sycamore.lan
